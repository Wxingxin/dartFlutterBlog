ä¸‹é¢æ˜¯ä¸€ä»½**ğŸ“˜ Dart è¯­è¨€ Futureï¼ˆå¼‚æ­¥ï¼‰çŸ¥è¯†ç‚¹å¤§å…¨**ï¼Œæˆ‘æŒ‰**æ ¸å¿ƒæ¦‚å¿µ â†’ ä½¿ç”¨æ–¹å¼ â†’ async/await â†’ é”™è¯¯å¤„ç† â†’ ç»„åˆå¹¶å‘ â†’ Flutter å®æˆ˜ â†’ é¢è¯•å‘**ç³»ç»Ÿæ•´ç†ã€‚æŠŠè¿™ä»½åƒé€ï¼Œä½ å¯¹ Dart/Flutter çš„å¼‚æ­¥å°±éå¸¸ç¨³äº†ã€‚

---

# ä¸€ã€Future æ˜¯ä»€ä¹ˆï¼ˆæ ¸å¿ƒæ¦‚å¿µï¼‰

**Future è¡¨ç¤ºâ€œä¸€ä¸ªæœªæ¥æ‰ä¼šå®Œæˆçš„ç»“æœâ€**ï¼Œè¦ä¹ˆæˆåŠŸè¿”å›å€¼ï¼Œè¦ä¹ˆå¤±è´¥æŠ›å¼‚å¸¸ã€‚

```dart
Future<int> future = Future.value(10);
```

ğŸ‘‰ ä¸‰ä¸ªçŠ¶æ€ï¼ˆæ¦‚å¿µï¼‰ï¼š

* **æœªå®Œæˆï¼ˆpendingï¼‰**
* **å®Œæˆå¹¶æˆåŠŸï¼ˆcompleted with valueï¼‰**
* **å®Œæˆä½†å¤±è´¥ï¼ˆcompleted with errorï¼‰**

---

# äºŒã€åˆ›å»º Future çš„æ–¹å¼ï¼ˆå¿…ä¼šï¼‰

## 1ï¸âƒ£ Future.value / Future.error

```dart
Future<int> f1 = Future.value(1);
Future<int> f2 = Future.error("error");
```

---

## 2ï¸âƒ£ Future(() {})ï¼ˆåŒæ­¥ä»£ç åŒ…è£…æˆå¼‚æ­¥ï¼‰

```dart
Future<int> f = Future(() {
  return 10;
});
```

> æ³¨æ„ï¼šå‡½æ•°ä½“**ç«‹å³æ‰§è¡Œ**ï¼Œç»“æœå¼‚æ­¥è¿”å›ã€‚

---

## 3ï¸âƒ£ å»¶æ—¶æ‰§è¡Œï¼ˆå¸¸ç”¨ï¼‰

```dart
Future.delayed(Duration(seconds: 1), () {
  return "done";
});
```

---

## 4ï¸âƒ£ async å‡½æ•°ï¼ˆæœ€å¸¸ç”¨ï¼‰

```dart
Future<int> fetch() async {
  return 10;
}
```

---

# ä¸‰ã€then / catchError / whenCompleteï¼ˆé“¾å¼ï¼‰

```dart
fetch()
  .then((value) {
    print(value);
  })
  .catchError((e) {
    print(e);
  })
  .whenComplete(() {
    print("ç»“æŸ");
  });
```

ğŸ‘‰ ç‰¹ç‚¹ï¼š

* then æ”¯æŒé“¾å¼è¿”å›
* catchError æ•è·å¼‚å¸¸
* whenComplete ç±»ä¼¼ finally

---

# å››ã€async / awaitï¼ˆğŸ”¥ æ ¸å¿ƒï¼‰

## 1ï¸âƒ£ åŸºæœ¬ç”¨æ³•

```dart
Future<void> main() async {
  int result = await fetch();
  print(result);
}
```

ğŸ‘‰ `await`ï¼š

* åªèƒ½åœ¨ `async` å‡½æ•°é‡Œç”¨
* **ä¸ä¼šé˜»å¡çº¿ç¨‹ï¼Œåªé˜»å¡å½“å‰å‡½æ•°**

---

## 2ï¸âƒ£ await é¡ºåºæ‰§è¡Œ

```dart
await task1();
await task2();
```

ğŸ‘‰ task2 å¿…é¡»ç­‰ task1 å®Œæˆ

---

## 3ï¸âƒ£ await å¹¶å‘æ‰§è¡Œï¼ˆæ€§èƒ½ç‚¹ï¼‰

```dart
final f1 = task1();
final f2 = task2();

await f1;
await f2;
```

---

# äº”ã€Future çš„é”™è¯¯å¤„ç†ï¼ˆå¿…è€ƒï¼‰

## 1ï¸âƒ£ try / catchï¼ˆæ¨èï¼‰

```dart
try {
  await fetch();
} catch (e) {
  print(e);
} finally {
  print("ç»“æŸ");
}
```

---

## 2ï¸âƒ£ then + catchErrorï¼ˆäº†è§£ï¼‰

```dart
fetch().catchError((e) {
  print(e);
});
```

---

## 3ï¸âƒ£ await ä¸æ•è· = ç¨‹åºå¼‚å¸¸

```dart
await Future.error("boom"); // âŒ æœªæ•è·ä¼šæŠ›åˆ°ä¸Šå±‚
```

---

# å…­ã€Future çš„æ³›å‹ï¼ˆç±»å‹å®‰å…¨ï¼‰

```dart
Future<String> f;
Future<void> f2;
```

âš ï¸ ä¸è¦ä¹±ç”¨ï¼š

```dart
Future f; // ç­‰ä»·äº Future<dynamic>
```

---

# ä¸ƒã€Future å¸¸ç”¨ç»„åˆï¼ˆğŸ”¥ é¢è¯•é«˜é¢‘ï¼‰

## 1ï¸âƒ£ Future.waitï¼ˆå¹¶å‘ + ç­‰å…¨éƒ¨ï¼‰

```dart
var results = await Future.wait([
  task1(),
  task2(),
  task3(),
]);
```

ğŸ‘‰ ä»»æ„ä¸€ä¸ªå¤±è´¥ â†’ æ•´ä½“å¤±è´¥

---

## 2ï¸âƒ£ Future.anyï¼ˆç¬¬ä¸€ä¸ªå®Œæˆï¼‰

```dart
await Future.any([
  task1(),
  task2(),
]);
```

---

## 3ï¸âƒ£ Future.timeoutï¼ˆè¶…æ—¶æ§åˆ¶ï¼‰

```dart
await fetch().timeout(Duration(seconds: 2));
```

---

# å…«ã€Future ä¸ null safety

```dart
Future<int?> f;
```

```dart
int? result = await f;
```

---

# ä¹ã€Future vs åŒæ­¥ä»£ç ï¼ˆâš ï¸ é‡è¦ç†è§£ï¼‰

```dart
print(1);
fetch();
print(2);
```

è¾“å‡ºï¼š

```
1
2
ï¼ˆä¹‹åæ‰æ˜¯ fetch çš„ç»“æœï¼‰
```

ğŸ‘‰ **Future ä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹**

---

# åã€Future ä¸äº‹ä»¶å¾ªç¯ï¼ˆç†è§£å³å¯ï¼‰

Dart æœ‰ï¼š

* **Microtask Queue**
* **Event Queue**

```dart
Future.microtask(() => print("micro"));
Future(() => print("event"));
```

æ‰§è¡Œé¡ºåºï¼š

```
micro
event
```

---

# åä¸€ã€Flutter ä¸­çš„ Futureï¼ˆğŸ”¥ å®æˆ˜ï¼‰

## 1ï¸âƒ£ FutureBuilderï¼ˆå¿…ä¼šï¼‰

```dart
FutureBuilder<int>(
  future: fetch(),
  builder: (context, snapshot) {
    if (snapshot.connectionState == ConnectionState.waiting) {
      return CircularProgressIndicator();
    }
    if (snapshot.hasError) {
      return Text("error");
    }
    return Text("${snapshot.data}");
  },
);
```

---

## 2ï¸âƒ£ initState ä¸­è°ƒç”¨ Future

```dart
@override
void initState() {
  super.initState();
  fetch();
}
```

âš ï¸ **ä¸è¦åœ¨ build é‡Œç›´æ¥è°ƒç”¨ Future**

---

## 3ï¸âƒ£ setState + Future

```dart
setState(() => isLoading = true);
await fetch();
setState(() => isLoading = false);
```

---

# åäºŒã€Future å¸¸è§é”™è¯¯æ€»ç»“ï¼ˆé¢è¯•å¿…è€ƒï¼‰

âŒ åœ¨ build ä¸­åˆ›å»º Future
âŒ å¿˜è®° await
âŒ Future.wait ä¸å¤„ç†å¼‚å¸¸
âŒ try/catch å†™åœ¨ await å¤–
âŒ Future<dynamic> æ»¥ç”¨
âŒ é¡ºåº await å¯¼è‡´æ€§èƒ½é—®é¢˜

---

# åä¸‰ã€Future vs Streamï¼ˆå¯¹æ¯”ï¼‰

| å¯¹æ¯” | Future       | Stream |
| -- | ------------ | ------ |
| ç»“æœ | 1 æ¬¡          | å¤šæ¬¡     |
| åœºæ™¯ | è¯·æ±‚ / è®¡ç®—      | æ•°æ®æµ    |
| ç›‘å¬ | await / then | listen |

---

# åå››ã€ä¸€å¥è¯è®°å¿†ç‰ˆ

> **Future = ä¸€æ¬¡æ€§å¼‚æ­¥ç»“æœï¼Œasync/await æ˜¯è¯­æ³•ç³–**

---

## ä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ç»§ç»­å¸®ä½ ğŸ‘‡

* âœ… **Stream çŸ¥è¯†ç‚¹å¤§å…¨ï¼ˆFuture çš„è¿›é˜¶ï¼‰**
* âœ… **Isolate / computeï¼ˆå¤šçº¿ç¨‹ï¼‰**
* âœ… **Flutter å¼‚æ­¥æœ€ä½³å®è·µ**
* âœ… **Future + ç½‘ç»œè¯·æ±‚å®Œæ•´å®æˆ˜**

ä½ ç›´æ¥è¯´ä¸‹ä¸€æ­¥å­¦å“ªä¸ªï¼Œæˆ‘å°±æ¥ç€ç»™ä½ æ•´ç† ğŸ‘
